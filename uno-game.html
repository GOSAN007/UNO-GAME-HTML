<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNOゲーム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            padding: 20px;
            position: relative;
        }

        .game-board {
            background: radial-gradient(ellipse at center, #4CAF50 0%, #2E7D32 100%);
            border-radius: 20px;
            height: 100%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* カードのスタイル */
        .card {
            width: 70px;
            height: 100px;
            border-radius: 8px;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 32px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .card.back {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-size: 16px;
        }

        .card.red { background: #FF5252; }
        .card.yellow { background: #FFD740; }
        .card.green { background: #69F0AE; }
        .card.blue { background: #448AFF; }
        .card.wild { 
            background: linear-gradient(45deg, #FF5252 25%, #FFD740 25%, #FFD740 50%, #69F0AE 50%, #69F0AE 75%, #448AFF 75%);
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }

        .card.selected {
            transform: translateY(-20px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.5);
        }

        .card .symbol {
            font-size: 20px;
            position: absolute;
            top: 5px;
            left: 5px;
            opacity: 0.8;
        }

        .card .symbol.bottom {
            top: auto;
            bottom: 5px;
            left: auto;
            right: 5px;
            transform: rotate(180deg);
        }

        /* プレイヤーエリア */
        .player-area {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
        }

        .opponent-area {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
        }

        .opponent-area .card {
            transform: scale(0.8);
        }

        /* プレイヤーターンアイコン */
        .player-turn-icon {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .player-turn-icon.active {
            opacity: 1;
        }

        .turn-arrow {
            font-size: 24px;
            color: #FFD740;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: bounce 1s infinite;
        }

        .turn-text {
            background: #FFD740;
            color: #333;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-8px);
            }
            60% {
                transform: translateY(-4px);
            }
        }

        /* 中央エリア */
        .center-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .discard-pile, .draw-pile {
            width: 90px;
            height: 130px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .draw-pile {
            background: rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .draw-pile:hover {
            background: rgba(0,0,0,0.5);
        }

        .pile-label {
            position: absolute;
            bottom: -25px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* ゲーム情報 */
        .game-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .turn-indicator {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2E7D32;
        }

        .game-status {
            font-size: 14px;
            color: #555;
        }

        /* ボタン */
        .action-button {
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .action-button:hover {
            background: #FF5252;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .uno-button {
            position: absolute;
            bottom: 150px;
            right: 50px;
            background: #FFD740;
            color: #333;
            padding: 15px 30px;
            font-size: 20px;
        }

        .game-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .restart-button {
            background: #4CAF50;
            font-size: 14px;
            padding: 8px 16px;
        }

        .restart-button:hover {
            background: #45a049;
        }

        .quit-button {
            background: #f44336;
            font-size: 14px;
            padding: 8px 16px;
        }

        .quit-button:hover {
            background: #da190b;
        }

        /* カラー選択モーダル */
        .color-picker {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .color-picker.active {
            display: block;
        }

        .color-picker h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .color-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .color-option {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid white;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.red { background: #FF5252; }
        .color-option.yellow { background: #FFD740; }
        .color-option.green { background: #69F0AE; }
        .color-option.blue { background: #448AFF; }



        /* メッセージ */
        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            display: none;
            z-index: 2000;
        }

        .message.active {
            display: block;
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(0.8); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* スタートメニュー */
        .start-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .start-menu.hidden {
            display: none;
        }

        .menu-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .menu-content h1 {
            font-size: 48px;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #FF5252, #FFD740, #69F0AE, #448AFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .start-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .card-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #FF5252;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="start-menu" id="startMenu">
        <div class="menu-content">
            <h1>UNO</h1>
            <p style="margin-bottom: 20px; color: #666;">クラシックカードゲーム</p>
            <button class="start-button" onclick="startGame()">ゲームスタート</button>
        </div>
    </div>

    <div class="game-container">
        <div class="game-board">
            <div class="opponent-area" id="opponentArea"></div>
            
            <div class="center-area">
                <div class="draw-pile" onclick="drawCard()">
                    <div class="card back">UNO</div>
                    <div class="pile-label">山札</div>
                    <div class="card-count" id="drawCount">0</div>
                </div>
                <div class="discard-pile" id="discardPile">
                    <div class="pile-label">捨て札</div>
                </div>
            </div>
            
            <div class="player-area" id="playerArea"></div>
            
            <!-- プレイヤーターンアイコン -->
            <div class="player-turn-icon" id="playerTurnIcon">
                <div class="turn-arrow">▲</div>
                <div class="turn-text">あなたの番</div>
            </div>
            
            <div class="game-info">
                <div class="turn-indicator" id="turnIndicator">あなたの番です</div>
                <div class="game-status" id="gameStatus">カードを選ぶか山札から引いてください</div>
            </div>
            
            <button class="action-button uno-button" onclick="callUno()">UNO!</button>
            <div class="game-controls">
                <button class="action-button restart-button" onclick="restartGame()">リスタート</button>
                <button class="action-button quit-button" onclick="quitGame()">終了</button>
            </div>
        </div>
    </div>

    <div class="color-picker" id="colorPicker">
        <h3>色を選んでください</h3>
        <div class="color-options">
            <div class="color-option red" onclick="selectWildColor('red')"></div>
            <div class="color-option yellow" onclick="selectWildColor('yellow')"></div>
            <div class="color-option green" onclick="selectWildColor('green')"></div>
            <div class="color-option blue" onclick="selectWildColor('blue')"></div>
        </div>
    </div>



    <div class="message" id="message"></div>

    <script>
        // ゲーム状態
        let gameState = {
            deck: [],
            discardPile: [],
            playerHand: [],
            opponentHand: [],
            currentPlayer: 'player',
            currentColor: null,
            currentValue: null,
            direction: 1,
            playerCalledUno: false,
            opponentCalledUno: false,
            gameStarted: false,
            lastCardPlayTime: null,
            canChallengeUno: false
        };

        // カードの生成
        function createDeck() {
            const colors = ['red', 'yellow', 'green', 'blue'];
            const values = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'skip', 'reverse', '+2'];
            const deck = [];

            // 通常カード
            colors.forEach(color => {
                values.forEach(value => {
                    deck.push({ color, value, type: 'normal' });
                    if (value !== '0') {
                        deck.push({ color, value, type: 'normal' });
                    }
                });
            });

            // ワイルドカード
            for (let i = 0; i < 4; i++) {
                deck.push({ color: 'wild', value: 'wild', type: 'wild' });
                deck.push({ color: 'wild', value: '+4', type: 'wild' });
            }

            return deck;
        }

        // カードのシャッフル
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ゲーム初期化
        function initGame() {
            gameState.deck = shuffle(createDeck());
            gameState.playerHand = [];
            gameState.opponentHand = [];
            gameState.discardPile = [];

            // 初期手札配布
            for (let i = 0; i < 7; i++) {
                gameState.playerHand.push(gameState.deck.pop());
                gameState.opponentHand.push(gameState.deck.pop());
            }

            // 最初の捨て札
            let firstCard;
            do {
                firstCard = gameState.deck.pop();
            } while (firstCard.type === 'wild');
            
            gameState.discardPile.push(firstCard);
            gameState.currentColor = firstCard.color;
            gameState.currentValue = firstCard.value;

            updateDisplay();
            
            // ゲーム開始の音声案内
            setTimeout(() => {
                speakGameStatus('ゲームを開始します。あなたの番です。');
            }, 1000);
        }

        // カード表示の作成
        function createCardElement(card, isOpponent = false) {
            const cardDiv = document.createElement('div');
            cardDiv.className = `card ${isOpponent ? 'back' : card.color}`;
            
            if (isOpponent) {
                cardDiv.textContent = 'UNO';
            } else {
                if (card.value === 'skip') {
                    cardDiv.innerHTML = '⊘';
                } else if (card.value === 'reverse') {
                    cardDiv.innerHTML = '⟲';
                } else if (card.value === '+2') {
                    cardDiv.innerHTML = '+2';
                } else if (card.value === '+4') {
                    cardDiv.innerHTML = '+4';
                } else if (card.value === 'wild') {
                    cardDiv.innerHTML = '✦';
                } else {
                    cardDiv.textContent = card.value;
                }
                
                // ワイルドカードで色が選択されている場合、色インジケーターを追加
                if (card.type === 'wild' && card.selectedColor) {
                    const colorIndicator = document.createElement('div');
                    colorIndicator.className = 'wild-color-indicator';
                    colorIndicator.style.cssText = `
                        position: absolute;
                        top: 5px;
                        right: 5px;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        border: 2px solid white;
                        background-color: ${getColorHex(card.selectedColor)};
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    `;
                    cardDiv.appendChild(colorIndicator);
                }
                
                // 小さい数字を角に追加
                if (card.value !== 'wild' && card.value !== '+4') {
                    const symbolTop = document.createElement('div');
                    symbolTop.className = 'symbol';
                    symbolTop.textContent = card.value === 'skip' ? '⊘' : 
                                         card.value === 'reverse' ? '⟲' : 
                                         card.value === '+2' ? '+2' : card.value;
                    cardDiv.appendChild(symbolTop);
                    
                    const symbolBottom = document.createElement('div');
                    symbolBottom.className = 'symbol bottom';
                    symbolBottom.textContent = symbolTop.textContent;
                    cardDiv.appendChild(symbolBottom);
                }
            }
            
            if (!isOpponent) {
                cardDiv.onclick = () => playCard(card);
            }
            
            return cardDiv;
        }

        // 表示更新
        function updateDisplay() {
            // プレイヤーの手札
            const playerArea = document.getElementById('playerArea');
            playerArea.innerHTML = '';
            gameState.playerHand.forEach(card => {
                playerArea.appendChild(createCardElement(card));
            });

            // 相手の手札
            const opponentArea = document.getElementById('opponentArea');
            opponentArea.innerHTML = '';
            gameState.opponentHand.forEach(() => {
                opponentArea.appendChild(createCardElement(null, true));
            });

            // 捨て札
            const discardPile = document.getElementById('discardPile');
            if (gameState.discardPile.length > 0) {
                const topCard = gameState.discardPile[gameState.discardPile.length - 1];
                discardPile.innerHTML = '<div class="pile-label">捨て札</div>';
                discardPile.appendChild(createCardElement(topCard));
            }

            // 山札カウント
            document.getElementById('drawCount').textContent = gameState.deck.length;

            // ターン表示
            const turnIndicator = document.getElementById('turnIndicator');
            const turnText = gameState.currentPlayer === 'player' ? 'あなたの番です' : 'CPUの番です';
            turnIndicator.textContent = turnText;
            
            // プレイヤーターンアイコンの表示/非表示
            const playerTurnIcon = document.getElementById('playerTurnIcon');
            if (gameState.currentPlayer === 'player') {
                playerTurnIcon.classList.add('active');
                
                // プレイヤーのターン時に出せるカードがあるかチェック
                checkPlayableCards();
            } else {
                playerTurnIcon.classList.remove('active');
            }
        }

        // カードが出せるかチェック
        function canPlayCard(card) {
            if (card.type === 'wild') return true;
            if (card.color === gameState.currentColor) return true;
            if (card.value === gameState.currentValue) return true;
            return false;
        }

        // プレイヤーが出せるカードがあるかチェック
        function checkPlayableCards() {
            const playableCards = gameState.playerHand.filter(card => canPlayCard(card));
            
            if (playableCards.length === 0) {
                showMessage('出せるカードがありません。山札からカードを引いてください。');
                speakGameStatus('出せるカードがありません。山札からカードを引いてください。');
            }
        }

        // カードをプレイ
        function playCard(card) {
            if (gameState.currentPlayer !== 'player') return;
            if (!canPlayCard(card)) {
                showMessage('このカードは出せません');
                return;
            }

            const index = gameState.playerHand.indexOf(card);
            if (index > -1) {
                // UNO宣言チェック（手札が2枚の時にカードを出す場合）
                if (gameState.playerHand.length === 2 && !gameState.playerCalledUno) {
                    // UNO宣言を忘れた場合の処理は次のターンで行う
                    gameState.canChallengeUno = true;
                    gameState.lastCardPlayTime = Date.now();
                }
                
                gameState.playerHand.splice(index, 1);
                gameState.discardPile.push(card);
                
                // 音声効果を追加
                playCardSound();
                
                // カード情報を音声で読み上げ（音声完了後に次の処理を実行）
                speakCard(card, () => {
                    if (card.type === 'wild') {
                        document.getElementById('colorPicker').classList.add('active');
                        return;
                    }
                    
                    gameState.currentColor = card.color;
                    gameState.currentValue = card.value;
                    
                    const shouldSkipOpponentTurn = handleSpecialCard(card);
                    
                    if (gameState.playerHand.length === 0) {
                        endGame('player');
                        return;
                    }
                    
                    // UNO宣言をリセット
                    gameState.playerCalledUno = false;
                    
                    // スキップ系カードの場合はターンを継続、そうでなければ相手のターンに
                    if (!shouldSkipOpponentTurn) {
                        gameState.currentPlayer = 'opponent';
                        updateDisplay();
                        setTimeout(() => opponentTurn(), 1500);
                    } else {
                        // ターンを継続（プレイヤーのまま）
                        updateDisplay();
                    }
                });
            }
        }

        // 特殊カードの処理
        function handleSpecialCard(card) {
            if (card.value === 'skip') {
                // スキップカード：相手のターンをスキップして自分のターンを継続
                // 二人プレイの場合、スキップは実質的に連続ターンになる
                showMessage('スキップ！もう一度あなたの番です');
                return true; // ターンをスキップ
            } else if (card.value === 'reverse') {
                // リバースカード：二人プレイの場合は方向を変えるだけで、ターンは通常通り交代
                gameState.direction *= -1;
                showMessage('リバース！方向が変わりました');
                return false; // ターンは通常通り交代
            } else if (card.value === '+2') {
                const targetHand = gameState.currentPlayer === 'player' ? gameState.opponentHand : gameState.playerHand;
                for (let i = 0; i < 2; i++) {
                    if (gameState.deck.length > 0) {
                        targetHand.push(gameState.deck.pop());
                    }
                }
                // +2カードも相手のターンをスキップ
                showMessage('+2カード！相手が2枚引いてターンスキップ');
                return true; // ターンをスキップ
            } else if (card.value === '+4') {
                // Wild Draw+4の効果を直接適用
                const targetHand = gameState.currentPlayer === 'player' ? gameState.opponentHand : gameState.playerHand;
                for (let i = 0; i < 4; i++) {
                    if (gameState.deck.length === 0) {
                        reshuffleDeck();
                    }
                    if (gameState.deck.length > 0) {
                        targetHand.push(gameState.deck.pop());
                    }
                }
                // +4カードも相手のターンをスキップ
                showMessage('+4カード！相手が4枚引いてターンスキップ');
                return true; // ターンをスキップ
            }
            return false; // 通常のカード、ターンは相手に移る
        }
        


        // 色名から16進数コードを取得
        function getColorHex(colorName) {
            const colorMap = {
                'red': '#FF5252',
                'yellow': '#FFD740',
                'green': '#69F0AE',
                'blue': '#448AFF'
            };
            return colorMap[colorName] || '#000000';
        }

        // ワイルドカードの色選択
        function selectWildColor(color) {
            document.getElementById('colorPicker').classList.remove('active');
            gameState.currentColor = color;
            gameState.currentValue = 'wild';
            
            // 捨て札の最後のカードに選択された色を記録
            const lastCard = gameState.discardPile[gameState.discardPile.length - 1];
            lastCard.selectedColor = color;
            
            handleSpecialCard(lastCard);
            
            if (gameState.playerHand.length === 0) {
                endGame('player');
                return;
            }
            
            gameState.currentPlayer = 'opponent';
            updateDisplay();
            
            setTimeout(() => opponentTurn(), 1500);
        }

        // カードを引く
        function drawCard() {
            if (gameState.currentPlayer !== 'player') return;
            if (gameState.deck.length === 0) {
                reshuffleDeck();
            }
            
            const drawnCard = gameState.deck.pop();
            gameState.playerHand.push(drawnCard);
            
            if (canPlayCard(drawnCard)) {
                showMessage('引いたカードが出せます！');
                speakGameStatus('引いたカードが出せます！');
            } else {
                showMessage('引いたカードも出せません。ターンを交代します。');
                speakGameStatus('引いたカードも出せません。ターンを交代します。');
                gameState.currentPlayer = 'opponent';
                setTimeout(() => opponentTurn(), 1500);
            }
            
            updateDisplay();
        }

        // 山札の再シャッフル
        function reshuffleDeck() {
            const topCard = gameState.discardPile.pop();
            gameState.deck = shuffle(gameState.discardPile);
            gameState.discardPile = [topCard];
        }

        // CPUのターン
        function opponentTurn() {
            if (gameState.currentPlayer !== 'opponent') return;
            
            // プレイヤーのUNO宣言忘れをチェック
            checkUnoPenalty();
            
            const playableCards = gameState.opponentHand.filter(card => canPlayCard(card));
            
            if (playableCards.length > 0) {
                // CPUのUNO宣言チェック（手札が2枚の時）
                if (gameState.opponentHand.length === 2) {
                    gameState.opponentCalledUno = true;
                    showMessage('CPU: UNO宣言！');
                }
                
                // プレイ可能なカードから選択
                const cardToPlay = playableCards[Math.floor(Math.random() * playableCards.length)];
                const index = gameState.opponentHand.indexOf(cardToPlay);
                gameState.opponentHand.splice(index, 1);
                gameState.discardPile.push(cardToPlay);
                
                // 音声効果を追加
                playCardSound();
                
                // CPUのカード情報を音声で読み上げ（音声完了後に次の処理を実行）
                setTimeout(() => {
                    speakCard(cardToPlay, () => {
                        if (cardToPlay.type === 'wild') {
                            const colors = ['red', 'yellow', 'green', 'blue'];
                            const selectedColor = colors[Math.floor(Math.random() * colors.length)];
                            gameState.currentColor = selectedColor;
                            gameState.currentValue = cardToPlay.value;
                            
                            // CPUが選択した色をカードに記録
                            cardToPlay.selectedColor = selectedColor;
                            
                            // 色名を日本語に変換
                            const colorNames = {
                                'red': '赤',
                                'yellow': '黄色',
                                'green': '緑',
                                'blue': '青'
                            };
                            const colorNameJp = colorNames[selectedColor];
                            
                            showMessage(`CPUが${colorNameJp}を選びました`);
                            speakGameStatus(`CPUが${colorNameJp}を選びました`);
                        } else {
                            gameState.currentColor = cardToPlay.color;
                            gameState.currentValue = cardToPlay.value;
                        }
                        
                        const shouldSkipPlayerTurn = handleSpecialCard(cardToPlay);
                        
                        if (gameState.opponentHand.length === 0) {
                            endGame('opponent');
                            return;
                        }
                        
                        if (gameState.opponentHand.length === 1 && gameState.opponentCalledUno) {
                            playUnoSound();
                            showMessage('CPU: UNO!');
                            setTimeout(() => {
                                speakGameStatus('CPUがウノ宣言しました！');
                            }, 500);
                        }
                        
                        // UNO宣言をリセット
                        gameState.opponentCalledUno = false;
                        
                        // スキップ系カードの場合はCPUのターンを継続、そうでなければプレイヤーのターンに
                        if (!shouldSkipPlayerTurn) {
                            gameState.currentPlayer = 'player';
                        } else {
                            // CPUのターンを継続
                            setTimeout(() => opponentTurn(), 1500);
                        }
                    });
                }, 300);
            } else {
                // カードを引く
                if (gameState.deck.length === 0) {
                    reshuffleDeck();
                }
                gameState.opponentHand.push(gameState.deck.pop());
                gameState.currentPlayer = 'player';
            }
            
            updateDisplay();
        }

        // UNOコール
        function callUno() {
            if (gameState.playerHand.length === 1) {
                gameState.playerCalledUno = true;
                playUnoSound();
                showMessage('UNO!');
                speakGameStatus('ウノ！');
            } else if (gameState.playerHand.length === 2) {
                gameState.playerCalledUno = true;
                playUnoSound();
                showMessage('UNO宣言！');
                speakGameStatus('ウノ宣言！');
            }
        }
        
        // UNO宣言忘れのペナルティチェック
        function checkUnoPenalty() {
            if (gameState.canChallengeUno && gameState.currentPlayer === 'opponent') {
                // プレイヤーがUNO宣言を忘れていた場合
                if (!gameState.playerCalledUno && gameState.playerHand.length === 1) {
                    // 2枚ペナルティ
                    for (let i = 0; i < 2; i++) {
                        if (gameState.deck.length === 0) {
                            reshuffleDeck();
                        }
                        if (gameState.deck.length > 0) {
                            gameState.playerHand.push(gameState.deck.pop());
                        }
                    }
                    showMessage('UNO宣言を忘れました！2枚ペナルティ');
                    setTimeout(() => {
                        speakGameStatus('ウノ宣言を忘れました。2枚ペナルティです。');
                    }, 300);
                }
                gameState.canChallengeUno = false;
            }
        }

        // メッセージ表示
        function showMessage(text) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.classList.add('active');
            setTimeout(() => {
                message.classList.remove('active');
            }, 2000);
        }

        // ゲーム終了
        function endGame(winner) {
            gameState.gameStarted = false;
            showMessage(winner === 'player' ? 'おめでとう！勝利！' : 'CPUの勝利...');
            
            // 勝利音声と音声案内
            if (winner === 'player') {
                playWinSound();
                setTimeout(() => {
                    speakGameStatus('おめでとうございます！あなたの勝利です！');
                }, 500);
            } else {
                setTimeout(() => {
                    speakGameStatus('CPUの勝利です。また挑戦してください。');
                }, 500);
            }
            
            setTimeout(() => {
                document.getElementById('startMenu').classList.remove('hidden');
            }, 3000);
        }
        
        // ゲームリスタート
        function restartGame() {
            // ゲーム状態をリセット
            gameState = {
                deck: [],
                discardPile: [],
                playerHand: [],
                opponentHand: [],
                currentPlayer: 'player',
                currentColor: null,
                currentValue: null,
                direction: 1,
                playerCalledUno: false,
                opponentCalledUno: false,
                gameStarted: false,
                lastCardPlayTime: null,
                canChallengeUno: false
            };
            
            // カラーピッカーを非表示
            document.getElementById('colorPicker').classList.remove('active');
            
            // メッセージを非表示
            document.getElementById('message').classList.remove('active');
            
            // ゲームを再初期化
            initGame();
            
            showMessage('ゲームをリスタートしました！');
            speakGameStatus('ゲームをリスタートしました！');
        }

        // ゲーム終了
        function quitGame() {
            if (confirm('ゲームを終了しますか？')) {
                // ゲーム状態をリセット
                gameState = {
                    deck: [],
                    discardPile: [],
                    playerHand: [],
                    opponentHand: [],
                    currentPlayer: 'player',
                    currentColor: null,
                    currentValue: null,
                    direction: 1,
                    playerCalledUno: false,
                    opponentCalledUno: false,
                    gameStarted: false,
                    lastCardPlayTime: null,
                    canChallengeUno: false
                };
                
                // 表示をクリア
                document.getElementById('playerArea').innerHTML = '';
                document.getElementById('opponentArea').innerHTML = '';
                document.getElementById('discardPile').innerHTML = '<div class="pile-label">捨て札</div>';
                document.getElementById('drawCount').textContent = '0';
                document.getElementById('turnIndicator').textContent = 'ゲーム終了';
                document.getElementById('gameStatus').textContent = 'リスタートボタンを押して新しいゲームを開始してください';
                document.getElementById('colorPicker').classList.remove('active');
                document.getElementById('message').classList.remove('active');
                document.getElementById('playerTurnIcon').classList.remove('active');
                
                showMessage('ゲームを終了しました');
                speakGameStatus('ゲームを終了しました');
            }
        }
        


        // ゲーム開始
        function startGame() {
            document.getElementById('startMenu').classList.add('hidden');
            gameState.gameStarted = true;
            initGame();
        }

        // 音声生成機能
        let audioContext;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // カード音声効果
        function playCardSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // UNO音声効果
        function playUnoSound() {
            initAudio();
            const oscillator1 = audioContext.createOscillator();
            const oscillator2 = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator1.connect(gainNode);
            oscillator2.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // UNO!の音（2つの音程）
            oscillator1.frequency.setValueAtTime(523, audioContext.currentTime); // C5
            oscillator1.frequency.setValueAtTime(659, audioContext.currentTime + 0.2); // E5
            
            oscillator2.frequency.setValueAtTime(392, audioContext.currentTime); // G4
            oscillator2.frequency.setValueAtTime(523, audioContext.currentTime + 0.2); // C5
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + 0.2);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator1.start(audioContext.currentTime);
            oscillator1.stop(audioContext.currentTime + 0.5);
            oscillator2.start(audioContext.currentTime);
            oscillator2.stop(audioContext.currentTime + 0.5);
        }
        
        // 勝利音声効果
        function playWinSound() {
            initAudio();
            const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
            
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + index * 0.15);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + index * 0.15);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + index * 0.15 + 0.3);
                
                oscillator.start(audioContext.currentTime + index * 0.15);
                oscillator.stop(audioContext.currentTime + index * 0.15 + 0.3);
            });
        }
        
        // エラー音声効果
        function playErrorSound() {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(100, audioContext.currentTime + 0.2);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        // 音声読み上げ機能
        function speakCard(card, callback) {
            if ('speechSynthesis' in window) {
                let text = '';
                
                // 色の読み上げ
                if (card.color === 'red') {
                    text += '赤の';
                } else if (card.color === 'yellow') {
                    text += '黄色の';
                } else if (card.color === 'green') {
                    text += '緑の';
                } else if (card.color === 'blue') {
                    text += '青の';
                } else if (card.type === 'wild') {
                    if (card.value === '+4') {
                        text = 'ワイルドドロー4';
                    } else {
                        text = 'ワイルドカード';
                    }
                }
                
                // 数字・記号の読み上げ
                if (card.type !== 'wild') {
                    if (card.value === 'skip') {
                        text += 'スキップ';
                    } else if (card.value === 'reverse') {
                        text += 'リバース';
                    } else if (card.value === '+2') {
                        text += 'ドロー2';
                    } else {
                        text += card.value;
                    }
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 1.2;
                utterance.volume = 0.7;
                
                // 音声読み上げ完了時のコールバック
                if (callback) {
                    utterance.onend = callback;
                }
                
                speechSynthesis.speak(utterance);
            } else if (callback) {
                // 音声合成が利用できない場合は即座にコールバックを実行
                callback();
            }
        }
        
        // ゲーム状況の音声読み上げ
        function speakGameStatus(message) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'ja-JP';
                utterance.rate = 1.0;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }
        
        // 初期化
        window.onload = () => {
            // 初期状態では何もしない（スタートメニューが表示される）
        };
    </script>
</body>
</html>